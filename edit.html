<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        #editor{background-color: bisque;height: 400px;margin: 50px;}
    </style>

</head>
<body>
<div id="editor">
    <p>asads<b>fdsgd</b>sfdsfdsfdasfdsfds</p>
    <p><br></p>
</div>

<script>
    const startObj = {};
    const endObj = {};
    let scopeObjects = [];
    let scopeParants = [];
    let scopeParantTagNames = [];
    let editorTarget;

    function init(target){
        editorTarget = document.getElementById( target );
        document.getElementById( target ).setAttribute( 'contenteditable', 'true' )
    }

    function findReturnObj(target, findObj){
        if( isSame(target, findObj) ){
            return target;
        }else{
            for(let i=0;target && i<target.childNodes.length;i++){
                const child = target.childNodes[i];
                let result = findReturnObj(child, findObj);

                if( result ){
                    return result;
                }
            }
        }
    }

    function setParents(target, callCnt) {
        callCnt = (callCnt || 0);
        if( callCnt == 0 ){
            scopeParants = [];
            scopeParantTagNames = [];
        }

        if (!isSame(target.parentNode, editorTarget)) {
            scopeParants.push(target.parentNode)
            scopeParantTagNames.push(target.parentNode.tagName)

            setParents(target.parentNode, (++callCnt));
        }
    }

    function getParents(){
        return scopeParants;
    }

    function getParentTagNames(){
        return scopeParantTagNames;
    }

    function setTargetObj(nodes){
        for(let i=0;i<nodes.length;i++){
            const node = nodes[i];
            scopeObjects.push(node);
        }
    }

    function getTargetObj(){
        return scopeObjects;
    }

    function getRangeNodes(){
        if( window.getSelection().type == 'None'){
            return;
        }

        startObj.container = window.getSelection().getRangeAt(0).startContainer;
        startObj.offset = window.getSelection().getRangeAt(0).startOffset;
        endObj.container = window.getSelection().getRangeAt(0).endContainer;
        endObj.offset = window.getSelection().getRangeAt(0).endOffset;

        if( window.getSelection().type == 'Caret' ){
            // setParents(window.getSelection().getRangeAt(0).commonAncestorContainer);
            // return getParents()[getParents().length-1];
            return window.getSelection().getRangeAt(0).commonAncestorContainer;
        }

        return window.getSelection().getRangeAt(0).commonAncestorContainer;
    }

    function isSame(original, target){
        return original === target;
    }

    function copyObj(target, deep){
        return target.cloneNode(deep || true);
    }

    function cover(target){
        const selectedEles = getRangeNodes();
        target = target.toUpperCase();

        if( !selectedEles ){
            return;
        }

        // 부모객체에 target과 동일한 태그가 있을 경우 로직 종료
        setParents(selectedEles)
        if( getParentTagNames().indexOf(target) > -1 ){
            return;
        }

        // 노드 앞에 동일한 태그가 있을 경우 앞에 있는 노드에 append 처리
        if( selectedEles.previousElementSibling && selectedEles.previousElementSibling.tagName == target ){
            const previousElement = selectedEles.previousElementSibling;
            selectedEles.previousElementSibling.appendChild(selectedEles);

            if( previousElement.nextElementSibling && previousElement.nextElementSibling.tagName == target ){
                for( let i=0;previousElement.nextElementSibling.childNodes && i<previousElement.nextElementSibling.childNodes.length;i++ ){
                    previousElement.appendChild(previousElement.nextElementSibling.childNodes[i]);
                }
                previousElement.nextElementSibling.remove();
            }

            return;
        }

        // 노드 뒤에 동일한 태그가 있을 경우 뒤에 있는 노드에 prepend 처리
        if( selectedEles.nextElementSibling && selectedEles.nextElementSibling.tagName == target ){
            const nextElement = selectedEles.nextElementSibling;
            selectedEles.nextElementSibling.firstChild.before(selectedEles);

            if( nextElement.previousElementSibling && nextElement.previousElementSibling.tagName == target ){
                for( let i=0;nextElement.previousElementSibling.childNodes && i<nextElement.previousElementSibling.childNodes.length;i++ ){
                    nextElement.firstChild.before(nextElement.previousElementSibling.childNodes[i]);
                }
                nextElement.previousElementSibling.remove();
            }

            return;
        }


        var targetTag = document.createElement( target );
        targetTag.appendChild(copyObj(selectedEles));

        selectedEles.parentNode.replaceChild(targetTag, selectedEles);
    }

    init('editor');
</script>

</body>
</html>
